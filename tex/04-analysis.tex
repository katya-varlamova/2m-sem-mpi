\chapter*{Техническое задание}
\addcontentsline{toc}{chapter}{Техническое задание}

\section*{Глоссарий}
\addcontentsline{toc}{section}{Глоссарий}

В данном техническом задании используются следующие обозначения:
\begin{enumerate}
	\item Узел системы -- региональный сервер, содержащий данные авторов и читателей указанного региона;
	\item Валидация -- проверка данных на соответствие заданным условиям и ограничениям;
	\item REST -- архитектурный стиль взаимодействия компонентов распределённого
	приложения в сети;
	\item Медиана времени отклика -- среднее время предоставления данных пользователю;
	\item Латентность географического положения -- увеличение времени отклика приложения, обуславливаемое географическим положением элементов системы или
	пользователя.
	\item Аутентификация -- процесс проверки подлинности пользователя или устройства.
	\item Авторизация -- это процесс проверки прав доступа.
	\item OpenID Connect -- это протокол аутентификации и авторизации, который строится на основе протокола OAuth 2.0.
	\item Identity Provider -- это сервис, который управляет аутентификацией и предоставляет информацию о пользователе в рамках системы аутентификации и авторизации;
    \item JSON -- это популярный формат текстовых данных, который используется для обмена данными в современных веб - и мобильных приложениях;
    \item JSON Web Token (JWT) -- объект, состоящий из трех частей: заголовка (header), полезной нагрузки (payload) и подписи; является открытым стандартом (RFC 7519) для создания токенов доступа, основанный на формате JSON;
    \item Kubernetes -- открытое программное обеспечение для оркестровки контейнеризированных приложений, автоматизации их развёртывания, масштабирования и координации в условиях кластера;
    \item Паттерн <<репозиторий>> -- это шаблон проектирования, представляющий собой абстрактный механизм хранения для коллекций сущностей;
    \item Паттерн <<пул объектов>> -- это шаблон проектирования, представляющий собой набор инициализированных и готовых к использованию объектов: когда системе требуется объект, он не создаётся, а берётся из пула; когда объектб ольше не нужен, он не уничтожается, а возвращается в пул;
    \item Паттерн <<фабрика объектов>> -- это порождающий шаблон проектирования для создания объектов, относящихся к одной предметной области, связанных логически.
\end{enumerate}

\section*{Введение}
\addcontentsline{toc}{section}{Введение}
В современном мире авиаперевозки становятся все более популярным способом путешествия, что требует эффективной системы бронирования авиабилетов. Разработка системы бронирования авиарейсов имеет высокую актуальность в связи с растущим спросом на авиаперевозки и необходимостью обеспечения удобства и оперативности процесса бронирования.

Данный проект представляет собой техническое задание на разработку портала бронирования авиабилетов, функциональность которого включает в себя возможность поиска и выбора оптимальных авиарейсов по различным критериям (цена, время вылета), онлайн-бронирование билетов, управление бронированиями, а также использование системы лояльности. 

В данном техническом задании будут описаны основные функциональные требования к порталу, архитектура системы и основные интеграции с другими сервисами.

\section*{Краткое описание предметной области}
\addcontentsline{toc}{section}{Краткое описание предметной области}

Система бронирования авиарейсов охватывает все аспекты планирования, организации и осуществления пассажирских авиаперевозок. Она включает в себя такие процессы, как поиск и сравнение авиабилетов, бронирование мест, управление тарифами и скидками.

\section*{Существующие аналоги}
\addcontentsline{toc}{section}{Существующие аналоги}

Среди аналогов разрабатываемого проекта можно выделить следующие:
\begin{itemize}
    \item Skyscanner: Это один из самых известных и широко используемых инструментов для поиска и бронирования авиабилетов. Система предоставляет информацию о рейсах более чем 1200 авиакомпаний и предлагает широкий выбор фильтров для поиска. Однако, Skyscanner не имеет прямого доступа к продаже авиабилетов, и клиенты должны перейти на сайт авиакомпании для бронирования.
    \item Google Flights: Еще одна популярная система бронирования авиабилетов, которая предлагает широкий спектр возможностей для поиска и сравнения цен. Google Flights использует алгоритмы машинного обучения для анализа данных и предоставления наиболее подходящих вариантов перелета. Однако, как и Skyscanner, Google Flights является только поисковым инструментом и не предоставляет возможности бронирования напрямую.
    \item Momondo: Эта система бронирования авиабилетов также предлагает большой выбор рейсов и направлений, а также позволяет сравнивать цены и выбирать наиболее подходящий вариант. Momondo имеет прямой доступ к продаже авиабилетов и предлагает различные дополнительные услуги, такие как страховка и помощь в оформлении документов.
\end{itemize}

Разрабатываемый проект должен обладать следующими преимуществами:
\begin{enumerate}
	\item собственная система лояльности: все приведённые выше сервисы являются лишь агрегаторами авиабилетов, но не предлагают систему лояльности;
	\item просмотр активных бронирований: приведённые сервисы не имеют личного кабинета пользователя, а потому не предоставляют возможности просмотра купленных билетов;
	\item возврат забронированных билетов: приведённые сервисы не имеют личного кабинета пользователя, а потому не предоставляют возможности возврата купленных билетов.
\end{enumerate}

\section*{Описание системы}
\addcontentsline{toc}{section}{Описание системы}

Разрабатываемый сервис должен представлять собой распределенную систему для управления бронированиями билетов на авиарейсы.

Пользователь может выступать в качестве:
\begin{itemize}
    \item клиента, который может посмотреть активные бронирования, забронировать новый билет или вернуть приобретённый ранее, а также посмотреть остаток средств на счёте программы лояльности;
    \item администратора, который может просматривать отчеты о работе системы бронирования.
\end{itemize}

\section*{Основания для разработки}
\addcontentsline{toc}{section}{Основания для разработки}

Разработка ведется в рамках выполнения лабораторных работ по курсу <<Методология программной инженерии>> на кафедре <<Программное обеспечение ЭВМ и информационные технологии>> факультета <<Информатика и системы управления>> МГТУ им. Н. Э. Баумана.


\section*{Назначение разработки}
\addcontentsline{toc}{section}{Назначение разработки}

Главное назначение разрабатываемого портала -- возможность пользоваться бонусными баллами вне зависимости от авиакомпании, у которой приобретаются билеты, а также управлять текущими бронированиями (просмотривать или удалять).

\section*{Требования к системе}
\addcontentsline{toc}{section}{Требования к системе}

\begin{enumerate}
    \item  Разрабатываемое программное обеспечение должно обеспечивать функционирование системы в режиме 24/7/365 со среднегодовым временем доступности не менее 99.9\%.
	\item Необходимо поддерживать возможность добавления нового
	узла во время работы системы без перезапуска.
	\item Каждый узел должен автоматически восстанавливаться после сбоя в течение 15 минут.
    \item Должна быть реализована деградация функциональности в случае отказа некритических источников.
\end{enumerate}

\section*{Требования к функциональным характеристикам}
\addcontentsline{toc}{section}{Требования к функциональным характеристикам}

\begin{enumerate}
	\item По результатам работы модуля сбора статистики медиана времени отклика системы на запросы пользователя на получение информации не должна превышать 3 секунд без учета латентности географического расположения узла;
	\item По результатам работы модуля сбора статистики медиана времени отклика системы на запросы, добавляющие или изменяющие информацию на портале не должна превышать 5 секунд без учета латентности географического расположения узла.
\end{enumerate}

\section*{Функциональные требования к порталу с точки зрения пользователя}
\addcontentsline{toc}{section}{Функциональные требования к порталу с точки зрения пользователя}

Портал должен обеспечивать реализацию следующих функций:
\begin{enumerate}
	\item Регистрация и авторизация пользователей с валидацией вводимых данных как через интерфейс приложения, так и через популярные социальные сети.
	\item Аутентификация пользователей.
	\item Ролевая модель пользователей. Выделяются следующие роли:
	\begin{itemize}
		\item покупатель;
		\item администратор.
	\end{itemize}
	\item покупатель имеет следующий набор функций:
	\begin{itemize}
		\item поиск билетов;
        \item покупка билета, в том числе с использованием бонусных баллов;
        \item просмотр купленных билетов;
		\item возврат билета;
        \item просмотр истории начисления и списания бонусных баллов;
        \item просмотр остатка на счёте бонусных баллов.
	\end{itemize}
	\item Администратор имеет функцию неограниченного полномочия по изменению контента на портале.
\end{enumerate}

\section*{Требования к надежности и к документации}
\addcontentsline{toc}{section}{Требования к надежности и к документации}

Система должна работать в соответствии с данным техническим заданием
без перезапуска. Необходимо использовать <<зеркалируемые серверы>> для всех подсистем, которые будут держать нагрузку в случае сбоя до тех пор, пока основной сервер не восстановится.

Исполнитель должен подготовить и передать Заказчику следующие документы:
\begin{itemize}
    \item руководство по развертыванию Системы;
    \item руководство администратора Системы;
    \item руководство для покупателя по использованию Системы.
\end{itemize}

\section*{Топология системы}  \label{topology}
\addcontentsline{toc}{section}{Топология системы}

Топология системы представлена на рисунке \ref{img:topology}.
\includeimage
{topology} % Имя файла без расширения (файл должен быть расположен в директории inc/img/)
{f} % Обтекание (без обтекания)
{H} % Положение рисунка (см. figure из пакета float)
{\textwidth} % Ширина рисунка
{Топология системы} % Подпись рисунка

Система должна состоять из 2 подсистем:
\begin{itemize}
    \item подсистема авторизации;
    \item подсистема бронирования рейсов.
\end{itemize}

Подсистема бронирования рейсов должна состоять из фронтенда и шести сервисов, что наиболее целесообразно для реализации ее основного назначения. 

Подсистема авторизации должна состоять из одного сервиса и html-страницы с полями для ввода логина и пароля, а также регистрации. 

Взаимодействие подсистемы бронирования авиарейсов с подсистемой авторизации должно осуществляться по протоколу OpenID Connect.

Все сервисы подсистемы бронирования рейсов должны взаимодействовать друг с другом через сервис-координатор, запросы с фронтенда в том числе сначала должны приходить на сервис-коорлинатор, а затем перенаправляться на нужный сервис. 

Сервисы, используемые пользователями часто (сервис сессий и пользователей, сервис-коордигнатор, сервис рейсов, сервис билетов, сервис программы лояльности) должны работать в нескольких экземплярах в разных географических позициях для обеспечения одинаковой задержки при загрузке страниц из разных географических позиций и, соответственно, меньшей нагрузки на сеть. Для реализации этого должна использоваться технология CDN, работающая в соответствии алгоритмом GeoDNS (алгоритм выбора сервера, который основан на географическом расположении пользователей). 

В рамках одной географической позиции также могут быть использованы несколько работающих экземпляров сервиса. Нагрузка между сервисами может быть распределена с помощью алгоритма RoundRobin.

При этом некоторые из дублируемых сервисов обращаются к своей локальной копии базы данных. Отсюда возникает необходимость синхронизации баз данных. Для этого могут быть использованы инструменты для работы с распределёнными транзакциями, встроенные в большинство популярных СУБД.


Фронтенд должен принимать запросы от пользователя по протоколу HTTP и возвращать ответ в виде HTML страниц, файлов стилей и java script.

Перечислим сервисы и их ответственность в системе.
\begin{enumerate}
    \item Сервис-координатор отвечает за координацию запросов внутри системы. Для реализации балансировки запросов используется инфраструктура Kubernetes.
    \item Сервис сессий и пользователей отвечает за сессию пользователей портала и реализует следующие функции:
    \begin{itemize}
        \item регистрация пользователя (покупателя); 
        \item авторизация пользователя (вход, или <<логин>>);
        \item выход из сессии (<<логаут>>).
        \item получение информации, изменение, удаление покупателя.
    \end{itemize}
    
    Сервис использует в своей работе базу данных. О каждом покупателе хранится следующая информация:
    \begin{itemize}
        \item логин (уникальное в рамках системы текстовое поле, максимум 80 символов);
        \item имя и фамилия (каждое является текстовым полем, максимум 80 символов);
        \item дата рождения.
    \end{itemize}
    \item Сервис программы лояльности реализует следующие функции:
    \begin{itemize}
        \item узнать баланс на счёте лояльности пользователя и историю изменения счёта лояльности с указанием для каждого события истории: суммы изменения, даты изменения, типа изменения и идентификатора билета, связанного с изменением; 
        \item произвести начисление бонусных баллов при покупке билета; 
        \item произвести списание бонусных баллов при возврате билета (при этом остаток бонусного счёта не может быть меньше 0).
    \end{itemize}

    Сервис программы лояльности использует в своей работе базу данных для хранения текущего баланса и истории изменений бонусного счёта каждого покупателя.

    \item Сервис билетов реализует следующие функции:
    \begin{itemize}
        \item получить информацию о всех купленных билетах пользователя; 
        \item получить информацию о билете пользователя с заданным идентификатором; 
        \item отметить билет купленным или возвращённым.
    \end{itemize}

     Сервис билетов использует в своей работе базу данных. О каждом билете хранится следующая информация:
    \begin{itemize}
        \item уникальный а рамках системы идентификатор билета;
        \item логин пользователя, купившего билет;
        \item идентифкатор рейса;
        \item цена билета;
        \item статус билета (оплачен / возвращён).
    \end{itemize}
    
    \item Сервис рейсов реализует следующие функции:
    \begin{itemize}
        \item получить информацию о всех рейсах; 
        \item получить информацию о рейсе с заданным идентификатором.
    \end{itemize}

    Сервис рейсов использует в своей работе базу данных. О каждом рейсе хранится следующая информация:
    \begin{itemize}
        \item уникальный а рамках системы идентификатор рейса;
        \item дата полёта;
        \item аэропорт отправления;
        \item аэропорт назначения;
        \item цена рейса.
    \end{itemize}

    \item Сервис оплаты отвечает взаимодейтсвие с внешними сервисами банка в части оплаты билетов и возврата билетов.
    
    \item Сервис статистики отвечает за логирование событий во всей системе для осуществления возможности быстрого детектирования, локализации и воспроизведения ошибки в случае её возникновения. 
\end{enumerate}

Кроме того, nginx отвечает за балансировку трафика между несколькими серверами сервера-координатора, а также за возврат ответов на статические запросы -- изображения, кеширование.

\section*{Требования по реализации со стороны заказчика}
\addcontentsline{toc}{section}{Требования по реализации со стороны заказчика}

\begin{enumerate}
	\item Требуется использовать сервис-ориентированную архитектуру для реализации системы.
    \item Требуется использование очереди сообщений Kafka для повышения отказоустойчивости системы.
	\item Система состоит из микросервисов. Каждый микросервис отвечает за свою область логики работы приложения.
	\item Взаимодействие между сервисами осуществляется посредством HTTP запросов.
	\item Данные сервисов должны храниться в базе данных. Каждый сервис взаимодействует только со своей схемой данных. Взаимодействие сервисов происходит по технологии REST.
	\item При недоступности систем портала должна осуществляться деградация функциональности или выдача пользователю сообщения об ошибке.
	\item Необходимо предусмотреть авторизацию пользователей через интерфейс приложения.
	\item Для авторизации использовать протокол OpenID Connect.
	\item Для запросов, выполняющих обновление данных на нескольких узлах распределенной системы, в случае недоступности одной из систем, необходимо выполнять полный откат транзакции.
	\item Приложение должно поддерживать возможность горизонтального и вертикального масштабирования за счет увеличения количества функционирующих узлов и совершенствования технологий реализации компонентов и всей архитектуры системы.
\end{enumerate}


\section*{Функциональные требования по подсистемам}
\addcontentsline{toc}{section}{Функциональные требования по подсистемам}

\begin{enumerate}
    \item Фронтенд -- это серверное приложение при разработке которого необходимо учитывать следующие факторы:
    \begin{itemize}
        \item фронтенд должен принимать запросы по протоколу HTTP и формировать ответы пользователям портала в формате HTML;
        \item в зависимости от типа запроса фронтенд должен отправлять последовательные запросы в соответствующие бекенды;
        \item запросы к бекендам необходимо осуществляет по протоколу HTTP; данные необходимо передавать в формате JSON;
        \item требуется использование веб-сервиса Nginx для более быстрого возврата пользователям статического содержимого (изображения, таблиц стилей, JavaScript файлов), а также для балансировки запросов к нескольким экземплярам сервиса-координатора.
    \end{itemize}
    \item Сервис пользователей, сервис сессий, сервис программы лояльности, сервис рейсов и сервис билетов -- это серверные приложения, которые должны отвечать следующим требованиям по разработке:
    \begin{itemize}
        \item обрабатывать запросы в соответствии со своим назначением, описанным в топологии системы;
        \item принимать и возвращать данные в формате JSON по протоколу HTTP;
        \item осуществлять доступ к СУБД по протоколу TCP.
    \end{itemize}
    \item Сервис-координатор -- это серверное приложение, которое должно отвечать следующим требованиям по разработке:
    \begin{itemize}
        \item обрабатывать запросы в соответствии со своим назначением, описанным в топологии системы;
        \item принимать и возвращать данные в формате JSON по протоколу HTTP;
        \item использовать очередь для отложенной обработки запросов (например, при временном отказе одного из сервисов);
        \item осуществлять деградацию функциональности в случае отказа некритического сервиса (зависит от семантики запроса);
        \item существовать в нескольких экземплярах, чтобы координация запросов не была узким местом приложения;
        \item уведомлять сервис статистики о событиях в системем.
    \end{itemize}
    \item Сервис статистики и сервис оплаты -- это серверные приложения, которые должны отвечать следующим требованиям по разработке:
    \begin{itemize}
        \item обрабатывать запросы в соответствии со своим назначением, описанным в топологии системы;
        \item принимать и возвращать данные в формате JSON по протоколу HTTP.
    \end{itemize}
\end{enumerate}

\section*{Сценарий взаимодействия фронтенда и бекендов}
\addcontentsline{toc}{section}{Сценарий взаимодействия фронтенда и бекендов}

Рассмотрим, как взаимодействуют фронтенд и бекенды на примере выполнения запроса от пользователя на получение списка рейсов.

\begin{enumerate}
    \item На фронтенд приходит данный запрос пользователя.
    \item Фронтенд анализирует запрос пользователя и, если пользователь был авторизован ранее, получает из него JWT-токен. Далее выполняется запрос к ближайшему географически наиболее свободному сервису-координатору. Координатор проверяет корректность полученных данных (того, что данные поступили в ожидаемом формате, то есть в формате, соответствующем протоколу взаимодействия). Координатор отправляет запрос на сервис рейсов. В сервисе рейсов осуществляется проверка корректности полученных данных (того, что данные поступили в ожидаемом формате, то есть в формате, соответствующем протоколу взаимодействия) и проверка JWT-токен-а (проверка того, что токен был подписан известным серверу ключом и того, что срок действия токена ещё не истёк). Если он истёк или оказался некорректным, пользователю возвращается ошибка. При успешной проверке токена сервис возвращает список рейсов сервису-координатору, который в свою очередь возвращает результат на фронтенд.
    \item Если ошибки нигде не произошло, то производится генерация HTML содержимого страницы ответа пользователю с использованием данных, полученных от сервиса рейсов. В ином случае генерируется страница с описанием ошибки.
\end{enumerate}


\section*{Пользовательский интерфейс}
\addcontentsline{toc}{section}{Пользовательский интерфейс}

Для реализации пользовательского интерфейса должен быть использован подход MVP (Model-View-Presenter). Этот подход к проектированию интерфейса является популярным шаблоном проектирования, который помогает разделить логику приложения на три основных компонента: Модель (Model), Представление (View) и Презентер (Presenter). Этот подход позволяет улучшить структуру приложения, облегчить его тестирование и управление.

Пользовательский интерфейс в разрабатываемой системе должен обладать следующими характеристиками:
\begin{itemize}
    \item Адаптивность к размеру экрана устройства пользователя -- пользовательский интерфейс <<подстраивается>> под всевозможные размеры экранов устройств: мобильных телефонов, планшетов, ноутбуков и т.д.
    \item Кроссбраузерность -- способность интерфейса работать практически в любом браузере любой версии. 
    \item <<Плоский» дизайн>>>> -- дизайн, в основе которого лежит идея отказа от объемных элементов (теней элементов, объемных кнопок и т.д.) и замены их плоскими аналогами.
    \item Расширяемость -- возможность легко расширять и модифицировать пользовательский интерфейс.
    \item Интуитивно понятный интерфейс -- все кнопки имеют подписи при наведении на них, многие содержат иконки, облегчающие восприятие пользователем.
\end{itemize}